# SPEC.md — Certificate Authority Service

## 1. Overview

### 1.1 Core Principle

**How a Certificate Authority issues, signs, revokes, and manages X.509 digital certificates through the certificate lifecycle, using a chain-of-trust model with Certificate Revocation List (CRL)-based revocation.**

This experiment explores PKI certificate lifecycle management from the CA's perspective. It is not a production CA. It demonstrates the exact operations a CA performs: creating a root key pair, signing end-entity certificates from CSRs, tracking certificate state, and publishing revocation information via CRLs.

### 1.2 Resolved Decisions

The following decisions resolve open questions from the research phase:

| ID | Decision | Rationale |
|----|----------|-----------|
| D-1 | **Language: Go** | Zero external dependencies for X.509 operations. Standard library covers certificates, CSRs, CRLs, key generation, PEM encoding. Single static binary output. |
| D-2 | **Default key algorithm: ECDSA P-256** | Modern, fast, small certificates. RSA 2048 also supported via `--key-algorithm` flag. Both use SHA-256 per assumption A-6. |
| D-3 | **External CSR support: Yes** | The CA accepts any valid PEM-encoded PKCS#10 CSR regardless of origin (generated by `ca request`, `openssl req`, or any other tool). |
| D-4 | **Default validity: 365 days (end-entity), 3650 days (root CA)** | Configurable via `--validity` flag on `ca init` and `ca sign`. |
| D-5 | **CA key encryption: None** | CA private key stored as unencrypted PEM on disk. Sufficient for a learning experiment. A warning is printed during init. |
| D-6 | **CRL reason codes: 5 supported** | `unspecified` (default), `keyCompromise`, `affiliationChanged`, `superseded`, `cessationOfOperation`. Covers the most common reasons without being exhaustive. |
| D-7 | **Certificate renewal: Out of scope** | PROJECT.md lists renewal as a key area to explore. For this experiment, renewal is mechanically identical to issuing a new certificate from a new CSR — it adds no new CA concept. Excluded to keep the experiment focused on the core lifecycle operations that are structurally distinct. |

### 1.3 Assumptions

- **A-1**: Go 1.21+ is installed on the development machine.
- **A-2**: Single-machine, single-operator scenario. No concurrency, no network service.
- **A-3**: ECDSA P-256 (default) or RSA 2048 keys are acceptable.
- **A-4**: File system is the persistence layer. No database.
- **A-5**: No interoperability with real-world TLS clients or browsers required. Validation uses the experiment's own logic or `openssl verify`.
- **A-6**: SHA-256 is the hash algorithm for all signatures.
- **A-7**: Root CA issues end-entity certificates only (no intermediate CAs).
- **A-8**: CRL-based revocation only. No OCSP.
- **A-9**: CLI-only interface.
- **A-10**: Behavioral validation scripts replace unit tests.
- **A-11**: Cross-platform (Windows, macOS, Linux).

---

## 2. Scope Boundaries

### 2.1 In Scope

1. **Root CA initialization** — Generate an ECDSA P-256 or RSA 2048 key pair and self-signed root CA certificate with proper extensions (Basic Constraints, Key Usage, Subject Key Identifier).
2. **CSR signing** — Accept a PEM-encoded CSR, validate it, and issue a signed end-entity certificate with configurable validity and standard extensions.
3. **Certificate storage** — Persist issued certificates as PEM files with a serial number counter and a JSON index tracking subject, validity, and status.
4. **Certificate revocation** — Mark a certificate as revoked by serial number with a reason code. Update revocation state in the index.
5. **CRL generation** — Produce a signed X.509 CRL v2 containing all revoked certificates, with `thisUpdate`/`nextUpdate` timestamps.
6. **Certificate listing** — List all issued certificates with their status (active, revoked, expired).
7. **Certificate verification** — Verify a certificate's signature against the CA, check validity period, and check revocation status against the CRL.
8. **CLI interface** — All operations exposed as CLI subcommands: `ca init`, `ca sign`, `ca revoke`, `ca crl`, `ca list`, `ca verify`, `ca request`.
9. **Behavioral validation** — Scripts that exercise the full lifecycle: init, generate CSR, sign, verify, revoke, generate CRL, verify revocation.

### 2.2 Out of Scope

- **OCSP responder** — Requires HTTP server and a second protocol.
- **Intermediate CA** — Root-only is sufficient for the experiment.
- **Certificate renewal** — Mechanically identical to issuance.
- **Key escrow or key recovery** — Production concern.
- **HSM integration** — Hardware dependency.
- **ACME protocol** — Separate protocol (RFC 8555).
- **Web UI or REST API** — CLI-only.
- **Database storage** — File-based storage is sufficient.
- **Certificate Transparency (CT) logs** — Requires external infrastructure.
- **Multi-user / access control** — Single-operator CLI.
- **Cross-signing or bridge CAs** — Advanced PKI topology.

### 2.3 Mocked / Simplified

1. **Identity verification** — The CA trusts the CSR at face value. No domain validation, organization validation, or extended validation. The CA signs whatever valid CSR it receives.
2. **Key protection** — CA private key stored as unencrypted PEM file on disk. A file-permission warning is printed during initialization.
3. **CRL distribution** — CRL written to a local file. No HTTP endpoint. Distribution is manual.
4. **Policy engine** — Minimal policy: verify CSR self-signature, check key type is ECDSA P-256 or RSA 2048, set default validity period. No name constraints, no maximum validity enforcement beyond the configured default.
5. **Audit logging** — Operations printed to stdout. No tamper-evident log.
6. **Clock/time source** — System clock used for all timestamps. No trusted time source.

---

## 3. Functional Requirements

### 3.1 Core Principle (CP)

**REQ-CP-001**: The system SHALL generate a root CA key pair (ECDSA P-256 or RSA 2048) and a self-signed X.509v3 root CA certificate during initialization. The root certificate SHALL have: version 3, a serial number of `01`, the CA's distinguished name as both issuer and subject, a validity period defaulting to 3650 days from the current time, and the extensions specified in REQ-DT-002.

**REQ-CP-002**: The system SHALL verify the self-signature of every CSR before issuing a certificate. If the CSR's self-signature is invalid, the system SHALL reject the CSR and not issue a certificate.

**REQ-CP-003**: The system SHALL issue a signed X.509v3 end-entity certificate from a valid CSR. The issued certificate SHALL contain: version 3, a unique serial number from the counter, the CA's distinguished name as issuer, the CSR subject as certificate subject, a validity period defaulting to 365 days, the subject's public key from the CSR, and the extensions specified in REQ-DT-003. The certificate SHALL be signed using the CA's private key with SHA-256.

**REQ-CP-004**: The system SHALL assign a unique, monotonically increasing serial number to each issued certificate. Serial numbers SHALL be represented as hexadecimal strings zero-padded to at least 2 digits (e.g., `01`, `02`, `0a`, `0b`). The root CA certificate SHALL receive serial `01`. The first issued end-entity certificate SHALL receive serial `02`. No two certificates SHALL share a serial number.

**REQ-CP-005**: The system SHALL revoke a certificate by serial number. Upon revocation, the system SHALL record the revocation timestamp (UTC) and a reason code in the certificate index. Supported reason codes: `unspecified`, `keyCompromise`, `affiliationChanged`, `superseded`, `cessationOfOperation`. The default reason code SHALL be `unspecified`.

**REQ-CP-006**: The system SHALL generate a signed X.509 CRL v2 containing the serial numbers and revocation dates of all revoked certificates, and no others. The CRL SHALL include `thisUpdate` (current time), `nextUpdate` (current time + configurable hours, default 24), a monotonically increasing CRL number, and the CA's signature. The CRL SHALL conform to the structure specified in REQ-DT-004.

**REQ-CP-007**: The system SHALL verify a given certificate by: (a) validating its signature against the CA certificate, (b) checking that the current time is within the certificate's validity period, and (c) checking the certificate's serial number against the CRL if a CRL file exists.

**REQ-CP-008**: The system SHALL list all issued end-entity certificates with their serial number, display status, expiry date, and subject. The display status SHALL be computed as: `revoked` if the certificate has been revoked, `expired` if `notAfter` is before the current time and the certificate is not revoked, `active` if `notAfter` is at or after the current time and the certificate is not revoked.

### 3.2 CLI Interface (CL)

**REQ-CL-001**: The system SHALL provide a `ca init` command that initializes the root CA. Syntax: `ca init --subject <DN> [--key-algorithm <algo>] [--validity <days>] [--data-dir <path>]`. The `--subject` flag is required. `--key-algorithm` accepts `ecdsa-p256` (default) or `rsa-2048`. `--validity` accepts a positive integer for days (default: `3650`). On success, the command SHALL print a summary to stdout and exit with code `0`.

**REQ-CL-002**: The system SHALL provide a `ca sign` command that signs a CSR. Syntax: `ca sign <csr-file> [--validity <days>] [--data-dir <path>]`. The `<csr-file>` positional argument is the path to a PEM-encoded PKCS#10 CSR file (required). `--validity` accepts a positive integer for days (default: `365`). On success, the command SHALL print a summary to stdout and exit with code `0`.

**REQ-CL-003**: The system SHALL provide a `ca revoke` command that revokes a certificate. Syntax: `ca revoke <serial> [--reason <reason>] [--data-dir <path>]`. The `<serial>` positional argument is the hexadecimal serial number of the certificate to revoke (required). `--reason` accepts one of: `unspecified` (default), `keyCompromise`, `affiliationChanged`, `superseded`, `cessationOfOperation`. On success, the command SHALL print a summary to stdout and exit with code `0`.

**REQ-CL-004**: The system SHALL provide a `ca crl` command that generates a CRL. Syntax: `ca crl [--next-update <hours>] [--data-dir <path>]`. `--next-update` accepts a positive integer for hours until the next CRL update (default: `24`). On success, the command SHALL print a summary to stdout and exit with code `0`.

**REQ-CL-005**: The system SHALL provide a `ca list` command that lists all issued certificates. Syntax: `ca list [--data-dir <path>]`. On success, the command SHALL print a table to stdout and exit with code `0`. If no end-entity certificates have been issued, the command SHALL print `No certificates issued.` and exit with code `0`.

**REQ-CL-006**: The system SHALL provide a `ca verify` command that verifies a certificate. Syntax: `ca verify <cert-file> [--data-dir <path>]`. The `<cert-file>` positional argument is the path to a PEM-encoded certificate file (required). On success (certificate is valid), exit with code `0`. On failure (invalid signature, expired, or revoked), exit with code `1`.

**REQ-CL-007**: The system SHALL provide a `ca request` utility command that generates a key pair and CSR for testing. Syntax: `ca request --subject <DN> [--san <san-list>] [--key-algorithm <algo>] --out-key <key-file> --out-csr <csr-file>`. The `--subject` flag is required. `--san` accepts a comma-separated list of Subject Alternative Names in the format `DNS:<name>` or `IP:<address>`. `--key-algorithm` accepts `ecdsa-p256` (default) or `rsa-2048`. `--out-key` and `--out-csr` are required and specify output file paths. On success, exit with code `0`.

**REQ-CL-008**: Every command SHALL accept a `--data-dir <path>` flag specifying the CA data directory. The default value SHALL be `./ca-data`. The `CA_DATA_DIR` environment variable SHALL also be accepted; the `--data-dir` flag takes precedence over the environment variable.

**REQ-CL-009**: The system SHALL use the following exit codes: `0` for success, `1` for operational errors (invalid CSR, revoked certificate, verification failure, etc.), `2` for usage errors (missing required flags, invalid flag values, unknown commands).

### 3.3 Data Format (DT)

**REQ-DT-001**: All certificates, private keys, CSRs, and CRLs SHALL be stored and exchanged in PEM format. Private keys SHALL use PKCS#8 encoding (`-----BEGIN PRIVATE KEY-----`). Certificates SHALL use `-----BEGIN CERTIFICATE-----`. CSRs SHALL use `-----BEGIN CERTIFICATE REQUEST-----`. CRLs SHALL use `-----BEGIN X509 CRL-----`.

**REQ-DT-002**: The root CA certificate SHALL be X.509 version 3 with the following extensions:
- **Basic Constraints** (critical): `cA=TRUE`
- **Key Usage** (critical): `keyCertSign`, `cRLSign`
- **Subject Key Identifier** (non-critical): SHA-1 hash of the CA's public key (per RFC 5280 method 1)

**REQ-DT-003**: Issued end-entity certificates SHALL be X.509 version 3 with the following extensions:
- **Basic Constraints** (critical): `cA=FALSE`
- **Key Usage** (critical): `digitalSignature` (always); additionally `keyEncipherment` if the subject key is RSA
- **Subject Alternative Name** (non-critical): copied from the CSR's SAN extension if present; omitted if the CSR has no SAN
- **Authority Key Identifier** (non-critical): the CA's Subject Key Identifier value
- **Subject Key Identifier** (non-critical): SHA-1 hash of the subject's public key

**REQ-DT-004**: The CRL SHALL be X.509 CRL version 2 with the following structure:
- **Issuer**: the CA's distinguished name
- **This Update**: the time the CRL was generated (UTC)
- **Next Update**: `thisUpdate` + configured hours (default 24)
- **Revoked Certificates**: list of entries, each containing serial number (hex), revocation date (UTC), and reason code
- **Authority Key Identifier** (non-critical): the CA's Subject Key Identifier value
- **CRL Number** (non-critical): monotonically increasing integer, starting at `1`
- **Signature**: signed by the CA's private key using SHA-256

**REQ-DT-005**: Serial numbers SHALL be stored and displayed as lowercase hexadecimal strings, zero-padded to at least 2 digits. The serial counter file SHALL contain the next serial number to be assigned. After `ca init`, the serial file SHALL contain `02` (the root certificate received `01`).

**REQ-DT-006**: The certificate index SHALL be a JSON file (`index.json`) containing an array of objects. Each object SHALL have the following fields:

| Field | Type | Description |
|-------|------|-------------|
| `serial` | string | Hex serial number (e.g., `"02"`) |
| `subject` | string | Certificate subject DN (e.g., `"CN=example.com,O=Example Inc,C=US"`) |
| `not_before` | string | RFC 3339 UTC timestamp (e.g., `"2026-01-06T00:00:00Z"`) |
| `not_after` | string | RFC 3339 UTC timestamp |
| `status` | string | `"active"` or `"revoked"` |
| `revoked_at` | string | RFC 3339 UTC timestamp when revoked, or `""` if not revoked |
| `revocation_reason` | string | Reason code string, or `""` if not revoked |

**REQ-DT-007**: The CA data directory SHALL have the following layout after initialization:

```
<data-dir>/
├── ca.key           # CA private key (PEM, PKCS#8)
├── ca.crt           # CA certificate (PEM, X.509v3)
├── serial           # Next serial number (hex string)
├── crlnumber        # Next CRL number (hex string, initialized to "01")
├── index.json       # Certificate index (JSON array, initialized to [])
└── certs/           # Directory for issued certificates
```

After issuing certificates and generating a CRL, the directory SHALL additionally contain:

```
<data-dir>/
├── ...              # (files above)
├── certs/
│   ├── 02.pem       # First issued certificate
│   ├── 03.pem       # Second issued certificate
│   └── ...
└── ca.crl           # Current CRL (PEM)
```

### 3.4 Error Handling (ER)

**REQ-ER-001**: If a CSR's self-signature verification fails, the system SHALL print `Error: CSR signature verification failed` to stderr and exit with code `1`.

**REQ-ER-002**: If any command other than `ca init` or `ca request` is run before `ca init` has been executed (i.e., `ca.key` and `ca.crt` do not exist in the data directory), the system SHALL print `Error: CA not initialized. Run 'ca init' first.` to stderr and exit with code `1`.

**REQ-ER-003**: If `ca revoke` is called with a serial number that does not exist in the certificate index, the system SHALL print `Error: certificate with serial <serial> not found` to stderr and exit with code `1`.

**REQ-ER-004**: If `ca revoke` is called with a serial number that is already revoked, the system SHALL print `Error: certificate with serial <serial> is already revoked` to stderr and exit with code `1`.

**REQ-ER-005**: If `ca init` is run when the data directory already contains `ca.key` or `ca.crt`, the system SHALL print `Error: CA already initialized at <data-dir>` to stderr and exit with code `1`.

**REQ-ER-006**: If a CSR contains a public key that is not ECDSA P-256 or RSA 2048, the system SHALL print `Error: unsupported key algorithm in CSR. Supported: ECDSA P-256, RSA 2048` to stderr and exit with code `1`.

**REQ-ER-007**: If `ca verify` is called with a certificate not signed by the CA, the system SHALL include `Signature: FAILED` in the output and exit with code `1`.

**REQ-ER-008**: If `ca sign` is called with a file that is not a valid PEM-encoded CSR, the system SHALL print `Error: failed to parse CSR from <file>` to stderr and exit with code `1`.

### 3.5 Mock Boundary (MK)

**REQ-MK-001**: The system SHALL sign any CSR that passes signature verification and key algorithm checks, without performing any identity verification. No domain validation, organization validation, or extended validation SHALL be performed.

**REQ-MK-002**: The system SHALL store the CA private key as an unencrypted PEM file. During `ca init`, the system SHALL print a warning to stdout: `Warning: CA private key is stored unencrypted at <path>. Protect this file.`

**REQ-MK-003**: The system SHALL write the CRL to a local file (`ca.crl` in the data directory). No HTTP distribution endpoint SHALL be provided.

**REQ-MK-004**: The system SHALL apply minimal issuance policy: (a) verify the CSR self-signature, (b) verify the CSR key algorithm is ECDSA P-256 or RSA 2048. No name constraints, path length constraints, or maximum validity enforcement beyond the configured default SHALL be applied.

**REQ-MK-005**: The system SHALL print an operation summary to stdout upon completion. Each summary SHALL begin with a status line (e.g., `Certificate issued successfully.`, `Certificate revoked successfully.`, `CRL generated successfully.`) followed by key details as shown in the interface contracts (Section 4). This serves as the audit log.

**REQ-MK-006**: The system SHALL use the system clock (`time.Now()` in Go) for all timestamp generation. No trusted time source is required.

---

## 4. Interface Contracts

### 4.1 CLI Commands

#### 4.1.1 `ca init`

**Syntax:**
```
ca init --subject <DN> [--key-algorithm ecdsa-p256|rsa-2048] [--validity <days>] [--data-dir <path>]
```

**Arguments and Flags:**

| Flag | Required | Default | Description |
|------|----------|---------|-------------|
| `--subject` | Yes | — | Distinguished Name for the root CA (e.g., `"CN=My Root CA,O=My Org,C=US"`) |
| `--key-algorithm` | No | `ecdsa-p256` | Key algorithm: `ecdsa-p256` or `rsa-2048` |
| `--validity` | No | `3650` | Validity period in days |
| `--data-dir` | No | `./ca-data` | CA data directory path |

**Stdout on success:**
```
CA initialized successfully.
  Subject:     CN=My Root CA,O=My Org,C=US
  Algorithm:   ECDSA P-256
  Serial:      01
  Not After:   <RFC3339 timestamp>
  Certificate: <data-dir>/ca.crt
  Key:         <data-dir>/ca.key
Warning: CA private key is stored unencrypted at <data-dir>/ca.key. Protect this file.
```

**Exit codes:** `0` success, `1` if CA already initialized, `2` if usage error.

#### 4.1.2 `ca sign`

**Syntax:**
```
ca sign <csr-file> [--validity <days>] [--data-dir <path>]
```

**Arguments and Flags:**

| Argument/Flag | Required | Default | Description |
|---------------|----------|---------|-------------|
| `<csr-file>` | Yes | — | Path to PEM-encoded PKCS#10 CSR file |
| `--validity` | No | `365` | Validity period in days |
| `--data-dir` | No | `./ca-data` | CA data directory path |

**Stdout on success:**
```
Certificate issued successfully.
  Serial:      02
  Subject:     CN=example.com,O=Example Inc,C=US
  Not After:   <RFC3339 timestamp>
  Certificate: <data-dir>/certs/02.pem
```

**Exit codes:** `0` success, `1` if CSR invalid/unsupported, `2` if usage error.

#### 4.1.3 `ca revoke`

**Syntax:**
```
ca revoke <serial> [--reason <reason>] [--data-dir <path>]
```

**Arguments and Flags:**

| Argument/Flag | Required | Default | Description |
|---------------|----------|---------|-------------|
| `<serial>` | Yes | — | Hex serial number of certificate to revoke |
| `--reason` | No | `unspecified` | Reason code: `unspecified`, `keyCompromise`, `affiliationChanged`, `superseded`, `cessationOfOperation` |
| `--data-dir` | No | `./ca-data` | CA data directory path |

**Stdout on success:**
```
Certificate revoked successfully.
  Serial: 02
  Reason: keyCompromise
```

**Exit codes:** `0` success, `1` if serial not found or already revoked, `2` if usage error.

#### 4.1.4 `ca crl`

**Syntax:**
```
ca crl [--next-update <hours>] [--data-dir <path>]
```

**Arguments and Flags:**

| Flag | Required | Default | Description |
|------|----------|---------|-------------|
| `--next-update` | No | `24` | Hours until next CRL update |
| `--data-dir` | No | `./ca-data` | CA data directory path |

**Stdout on success:**
```
CRL generated successfully.
  This Update:          <RFC3339 timestamp>
  Next Update:          <RFC3339 timestamp>
  CRL Number:           1
  Revoked certificates: <count>
  CRL: <data-dir>/ca.crl
```

**Exit codes:** `0` success, `1` if CA not initialized, `2` if usage error.

#### 4.1.5 `ca list`

**Syntax:**
```
ca list [--data-dir <path>]
```

**Stdout (with certificates):**
```
SERIAL  STATUS   NOT AFTER             SUBJECT
02      active   2027-02-09T00:00:00Z  CN=example.com,O=Example Inc,C=US
03      revoked  2027-02-09T00:00:00Z  CN=test.example.com
```

**Stdout (no certificates):**
```
No certificates issued.
```

**Exit codes:** `0` success, `1` if CA not initialized, `2` if usage error.

#### 4.1.6 `ca verify`

**Syntax:**
```
ca verify <cert-file> [--data-dir <path>]
```

**Arguments and Flags:**

| Argument/Flag | Required | Default | Description |
|---------------|----------|---------|-------------|
| `<cert-file>` | Yes | — | Path to PEM-encoded certificate file |
| `--data-dir` | No | `./ca-data` | CA data directory path |

**Stdout (valid certificate):**
```
Certificate verification: VALID
  Subject:    CN=example.com,O=Example Inc,C=US
  Serial:     02
  Issuer:     CN=My Root CA,O=My Org,C=US
  Not Before: <RFC3339 timestamp>
  Not After:  <RFC3339 timestamp>
  Signature:  OK
  Expiry:     OK
  Revocation: OK (not revoked)
```

**Stdout (revoked certificate):**
```
Certificate verification: INVALID
  Subject:    CN=example.com,O=Example Inc,C=US
  Serial:     02
  Issuer:     CN=My Root CA,O=My Org,C=US
  Not Before: <RFC3339 timestamp>
  Not After:  <RFC3339 timestamp>
  Signature:  OK
  Expiry:     OK
  Revocation: REVOKED (reason: keyCompromise, date: <RFC3339 timestamp>)
```

**Stdout (no CRL available):**
```
Certificate verification: VALID
  Subject:    CN=example.com,O=Example Inc,C=US
  Serial:     02
  Issuer:     CN=My Root CA,O=My Org,C=US
  Not Before: <RFC3339 timestamp>
  Not After:  <RFC3339 timestamp>
  Signature:  OK
  Expiry:     OK
  Revocation: NOT CHECKED (no CRL available)
```

**Stdout (invalid signature):**
```
Certificate verification: INVALID
  Subject:    <subject from cert>
  Serial:     <serial from cert>
  Issuer:     <issuer from cert>
  Not Before: <RFC3339 timestamp>
  Not After:  <RFC3339 timestamp>
  Signature:  FAILED
```

**Exit codes:** `0` if VALID, `1` if INVALID or operational error, `2` if usage error.

#### 4.1.7 `ca request` (utility)

**Syntax:**
```
ca request --subject <DN> [--san <san-list>] [--key-algorithm ecdsa-p256|rsa-2048] --out-key <key-file> --out-csr <csr-file>
```

**Arguments and Flags:**

| Flag | Required | Default | Description |
|------|----------|---------|-------------|
| `--subject` | Yes | — | Distinguished Name for the CSR (e.g., `"CN=example.com,O=Example Inc,C=US"`) |
| `--san` | No | — | Comma-separated SANs: `DNS:example.com,DNS:www.example.com,IP:192.168.1.1` |
| `--key-algorithm` | No | `ecdsa-p256` | Key algorithm: `ecdsa-p256` or `rsa-2048` |
| `--out-key` | Yes | — | Output path for the generated private key (PEM) |
| `--out-csr` | Yes | — | Output path for the generated CSR (PEM) |

**Stdout on success:**
```
CSR generated successfully.
  Subject:   CN=example.com,O=Example Inc,C=US
  Algorithm: ECDSA P-256
  Key:       /path/to/example.key
  CSR:       /path/to/example.csr
```

**Exit codes:** `0` success, `2` if usage error.

**Error behavior:**
- If `--san` is provided with values not in the format `DNS:<name>` or `IP:<address>`: exit code `2` with a usage error message to stderr.

**Note:** This command does not require an initialized CA. It is a standalone utility for generating test CSRs.

### 4.2 Data Formats

#### 4.2.1 Certificate Index (`index.json`)

```json
[
  {
    "serial": "02",
    "subject": "CN=example.com,O=Example Inc,C=US",
    "not_before": "2026-02-09T12:00:00Z",
    "not_after": "2027-02-09T12:00:00Z",
    "status": "active",
    "revoked_at": "",
    "revocation_reason": ""
  },
  {
    "serial": "03",
    "subject": "CN=test.example.com",
    "not_before": "2026-02-09T12:30:00Z",
    "not_after": "2027-02-09T12:30:00Z",
    "status": "revoked",
    "revoked_at": "2026-03-15T10:00:00Z",
    "revocation_reason": "keyCompromise"
  }
]
```

**Constraints:**
- The array SHALL contain only end-entity certificates (not the root CA certificate).
- The `status` field SHALL be `"active"` or `"revoked"`. Expiry is computed at display time, not stored.
- All timestamps SHALL be RFC 3339 UTC format (ending in `Z`).
- The `revoked_at` and `revocation_reason` fields SHALL be empty strings (`""`) when the certificate is not revoked.

#### 4.2.2 Serial File (`serial`)

Plain text file containing a single line: the next serial number to assign, as a lowercase hexadecimal string, zero-padded to at least 2 digits.

**Example contents after init:** `02`
**Example contents after 2 certificates issued:** `04`

#### 4.2.3 CRL Number File (`crlnumber`)

Plain text file containing a single line: the next CRL number to assign, as a lowercase hexadecimal string, zero-padded to at least 2 digits.

**Example contents after init:** `01`
**Example contents after 1 CRL generated:** `02`

---

## 5. Behavior Scenarios

### 5.1 Core Principle Scenarios (CP)

```
SCN-CP-001: Full lifecycle — init, sign, verify, revoke, CRL, verify revocation
Traces to: REQ-CP-001, REQ-CP-002, REQ-CP-003, REQ-CP-005, REQ-CP-006, REQ-CP-007
Given: An empty directory ./test-ca-data exists
When:  The following commands are executed in sequence:
       1. ca init --subject "CN=Test Root CA,O=Test Org,C=US" --data-dir ./test-ca-data
       2. ca request --subject "CN=leaf.example.com" --san "DNS:leaf.example.com" --out-key ./leaf.key --out-csr ./leaf.csr
       3. ca sign ./leaf.csr --data-dir ./test-ca-data
       4. ca verify ./test-ca-data/certs/02.pem --data-dir ./test-ca-data
       5. ca revoke 02 --reason keyCompromise --data-dir ./test-ca-data
       6. ca crl --data-dir ./test-ca-data
       7. ca verify ./test-ca-data/certs/02.pem --data-dir ./test-ca-data
Then:  Step 1 exits with code 0 and stdout contains "CA initialized successfully."
       Step 2 exits with code 0 and creates ./leaf.key and ./leaf.csr
       Step 3 exits with code 0 and stdout contains "Serial:      02"
       Step 4 exits with code 0 and stdout contains "Certificate verification: VALID"
       Step 5 exits with code 0 and stdout contains "Certificate revoked successfully."
       Step 6 exits with code 0 and stdout contains "Revoked certificates: 1"
       Step 7 exits with code 1 and stdout contains "Certificate verification: INVALID"
       Step 7 stdout contains "Revocation: REVOKED (reason: keyCompromise"
```

```
SCN-CP-002: Root CA initialization creates valid self-signed certificate
Traces to: REQ-CP-001, REQ-DT-002
Given: An empty directory ./test-ca-data exists
When:  ca init --subject "CN=Test Root CA,O=Test Org,C=US" --key-algorithm ecdsa-p256 --validity 3650 --data-dir ./test-ca-data
Then:  Exit code is 0
       File ./test-ca-data/ca.key exists and begins with "-----BEGIN PRIVATE KEY-----"
       File ./test-ca-data/ca.crt exists and begins with "-----BEGIN CERTIFICATE-----"
       File ./test-ca-data/serial exists and contains "02"
       File ./test-ca-data/crlnumber exists and contains "01"
       File ./test-ca-data/index.json exists and contains "[]"
       Directory ./test-ca-data/certs/ exists
       The certificate subject is "CN=Test Root CA,O=Test Org,C=US"
       The certificate issuer equals the certificate subject (self-signed)
       The certificate serial number is 01 (hex)
       The certificate version is 3
       The certificate has Basic Constraints extension with cA=TRUE, marked critical
       The certificate has Key Usage extension with keyCertSign and cRLSign, marked critical
       The certificate has Subject Key Identifier extension, marked non-critical
       The certificate's notAfter is approximately 3650 days after notBefore
       Stdout contains "Warning: CA private key is stored unencrypted"
```

```
SCN-CP-003: CSR signature verification rejects tampered CSR
Traces to: REQ-CP-002, REQ-ER-001
Given: CA is initialized at ./test-ca-data
       A file ./bad.csr exists containing a PEM-encoded CSR whose signature bytes have been modified (invalid signature)
When:  ca sign ./bad.csr --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CSR signature verification failed"
       The serial file remains unchanged (no certificate was issued)
       The index.json file remains unchanged
```

```
SCN-CP-004: Serial numbers increment with each issued certificate
Traces to: REQ-CP-004
Given: CA is initialized at ./test-ca-data (serial file contains "02")
       A valid CSR ./first.csr exists
       A valid CSR ./second.csr exists
When:  ca sign ./first.csr --data-dir ./test-ca-data
       ca sign ./second.csr --data-dir ./test-ca-data
Then:  First sign command stdout contains "Serial:      02"
       File ./test-ca-data/certs/02.pem exists
       Second sign command stdout contains "Serial:      03"
       File ./test-ca-data/certs/03.pem exists
       File ./test-ca-data/serial contains "04"
       The index.json contains 2 entries with serials "02" and "03"
```

```
SCN-CP-005: Revocation records timestamp and reason
Traces to: REQ-CP-005
Given: CA is initialized at ./test-ca-data
       Certificate with serial 02 has been issued and is active in index.json
When:  ca revoke 02 --reason superseded --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "Certificate revoked successfully."
       Stdout contains "Serial: 02"
       Stdout contains "Reason: superseded"
       In index.json, the entry with serial "02" has status "revoked"
       In index.json, the entry with serial "02" has revocation_reason "superseded"
       In index.json, the entry with serial "02" has a non-empty revoked_at timestamp in RFC 3339 UTC format
```

```
SCN-CP-006: CRL contains exactly the revoked certificates
Traces to: REQ-CP-006, REQ-DT-004
Given: CA is initialized at ./test-ca-data
       Certificates with serials 02, 03, and 04 have been issued
       Certificate 02 is revoked with reason keyCompromise
       Certificate 04 is revoked with reason cessationOfOperation
       Certificate 03 is still active
When:  ca crl --next-update 48 --data-dir ./test-ca-data
Then:  Exit code is 0
       File ./test-ca-data/ca.crl exists and begins with "-----BEGIN X509 CRL-----"
       Stdout contains "Revoked certificates: 2"
       Stdout contains "CRL Number:           1"
       The CRL issuer matches the CA certificate subject
       The CRL contains serial 02 with revocation date
       The CRL contains serial 04 with revocation date
       The CRL does NOT contain serial 03
       The CRL nextUpdate is approximately 48 hours after thisUpdate
       File ./test-ca-data/crlnumber contains "02"
```

```
SCN-CP-007: Verification detects revoked certificate after CRL generation
Traces to: REQ-CP-007
Given: CA is initialized at ./test-ca-data
       Certificate with serial 02 has been issued (file ./test-ca-data/certs/02.pem)
       Certificate 02 has been revoked with reason keyCompromise
       CRL has been generated at ./test-ca-data/ca.crl containing serial 02
When:  ca verify ./test-ca-data/certs/02.pem --data-dir ./test-ca-data
Then:  Exit code is 1
       Stdout contains "Certificate verification: INVALID"
       Stdout contains "Signature:  OK"
       Stdout contains "Expiry:     OK"
       Stdout contains "Revocation: REVOKED (reason: keyCompromise"
```

```
SCN-CP-008: Verification without CRL reports NOT CHECKED
Traces to: REQ-CP-007
Given: CA is initialized at ./test-ca-data
       Certificate with serial 02 has been issued (file ./test-ca-data/certs/02.pem)
       No CRL file exists at ./test-ca-data/ca.crl
When:  ca verify ./test-ca-data/certs/02.pem --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "Certificate verification: VALID"
       Stdout contains "Signature:  OK"
       Stdout contains "Expiry:     OK"
       Stdout contains "Revocation: NOT CHECKED (no CRL available)"
```

### 5.2 CLI Interface Scenarios (CL)

```
SCN-CL-001: ca init with defaults creates CA using ECDSA P-256
Traces to: REQ-CL-001, REQ-CL-008
Given: An empty directory ./test-ca-data exists
When:  ca init --subject "CN=My CA" --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "Algorithm:   ECDSA P-256"
       Stdout contains "Subject:     CN=My CA"
       The CA certificate uses ECDSA P-256 for its public key
       The CA certificate signature algorithm is ECDSA with SHA-256
```

```
SCN-CL-002: ca init with RSA 2048
Traces to: REQ-CL-001
Given: An empty directory ./test-ca-data exists
When:  ca init --subject "CN=RSA CA" --key-algorithm rsa-2048 --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "Algorithm:   RSA 2048"
       The CA certificate uses RSA 2048-bit for its public key
       The CA certificate signature algorithm is SHA-256 with RSA
```

```
SCN-CL-003: ca sign issues certificate from CSR file
Traces to: REQ-CL-002, REQ-CP-003
Given: CA is initialized at ./test-ca-data
       A valid CSR file ./server.csr exists with subject CN=server.example.com and SAN DNS:server.example.com
When:  ca sign ./server.csr --validity 180 --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "Certificate issued successfully."
       Stdout contains "Subject:     CN=server.example.com"
       The issued certificate's notAfter is approximately 180 days after notBefore
       The issued certificate's SAN contains DNS:server.example.com
```

```
SCN-CL-004: ca revoke with default reason uses unspecified
Traces to: REQ-CL-003, REQ-CP-005
Given: CA is initialized at ./test-ca-data
       Certificate with serial 02 exists and is active
When:  ca revoke 02 --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "Reason: unspecified"
       In index.json, serial 02 has revocation_reason "unspecified"
```

```
SCN-CL-005: ca list shows issued certificates with status
Traces to: REQ-CL-005, REQ-CP-008
Given: CA is initialized at ./test-ca-data
       Certificate serial 02 (CN=alpha.com) is active, not_after is in the future
       Certificate serial 03 (CN=beta.com) is revoked
When:  ca list --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "SERIAL  STATUS   NOT AFTER"
       Stdout contains a line with "02" and "active" and "CN=alpha.com"
       Stdout contains a line with "03" and "revoked" and "CN=beta.com"
```

```
SCN-CL-006: ca list with no certificates prints message
Traces to: REQ-CL-005
Given: CA is initialized at ./test-ca-data
       No end-entity certificates have been issued (index.json is [])
When:  ca list --data-dir ./test-ca-data
Then:  Exit code is 0
       Stdout contains "No certificates issued."
```

```
SCN-CL-007: ca request generates key pair and CSR with SANs
Traces to: REQ-CL-007
Given: No preconditions (ca request does not require an initialized CA)
When:  ca request --subject "CN=web.example.com,O=Web Corp,C=US" --san "DNS:web.example.com,DNS:www.web.example.com,IP:10.0.0.1" --out-key ./web.key --out-csr ./web.csr
Then:  Exit code is 0
       File ./web.key exists and begins with "-----BEGIN PRIVATE KEY-----"
       File ./web.csr exists and begins with "-----BEGIN CERTIFICATE REQUEST-----"
       Stdout contains "Subject:   CN=web.example.com,O=Web Corp,C=US"
       The CSR contains subject CN=web.example.com,O=Web Corp,C=US
       The CSR contains SAN DNS:web.example.com
       The CSR contains SAN DNS:www.web.example.com
       The CSR contains SAN IP:10.0.0.1
       The CSR self-signature is valid
```

```
SCN-CL-008: Environment variable CA_DATA_DIR is used as default
Traces to: REQ-CL-008
Given: CA is initialized at /tmp/my-test-ca
       Environment variable CA_DATA_DIR is set to /tmp/my-test-ca
When:  ca list
Then:  Exit code is 0
       The command reads from /tmp/my-test-ca/index.json (not ./ca-data/index.json)
```

```
SCN-CL-009: --data-dir flag overrides CA_DATA_DIR environment variable
Traces to: REQ-CL-008
Given: CA is initialized at /tmp/flag-ca but NOT at /tmp/env-ca
       Environment variable CA_DATA_DIR is set to /tmp/env-ca
When:  ca list --data-dir /tmp/flag-ca
Then:  Exit code is 0
       The command reads from /tmp/flag-ca/index.json (overrides the env var)
```

```
SCN-CL-010: Exit code 2 for missing required flag
Traces to: REQ-CL-009
Given: No preconditions
When:  ca init (without the required --subject flag)
Then:  Exit code is 2
       Stderr contains a usage error message
```

```
SCN-CL-011: Exit code 2 for invalid flag value
Traces to: REQ-CL-009
Given: No preconditions
When:  ca init --subject "CN=Test" --key-algorithm ed25519
Then:  Exit code is 2
       Stderr contains a usage error message indicating invalid key algorithm
```

```
SCN-CL-012: Exit code 2 for unknown command
Traces to: REQ-CL-009
Given: No preconditions
When:  ca renew (an unknown subcommand)
Then:  Exit code is 2
       Stderr contains a usage error message indicating unknown command
```

```
SCN-CL-013: Exit code 2 for invalid SAN format in ca request
Traces to: REQ-CL-007, REQ-CL-009
Given: No preconditions
When:  ca request --subject "CN=test.com" --san "INVALID:test.com" --out-key ./t.key --out-csr ./t.csr
Then:  Exit code is 2
       Stderr contains a usage error message indicating invalid SAN format
```

### 5.3 Data Format Scenarios (DT)

```
SCN-DT-001: Root certificate has correct X.509v3 extensions
Traces to: REQ-DT-001, REQ-DT-002
Given: An empty directory ./test-ca-data exists
When:  ca init --subject "CN=Extension Test CA,O=Test,C=US" --data-dir ./test-ca-data
Then:  The file ./test-ca-data/ca.crt is a valid PEM-encoded X.509v3 certificate
       The certificate version is 3
       Extension Basic Constraints is present, critical, with cA=TRUE
       Extension Key Usage is present, critical, with keyCertSign and cRLSign bits set
       Extension Subject Key Identifier is present, non-critical
       The certificate serial number in hex is "01"
       The certificate signature algorithm uses SHA-256
```

```
SCN-DT-002: End-entity certificate has correct X.509v3 extensions
Traces to: REQ-DT-001, REQ-DT-003
Given: CA is initialized at ./test-ca-data
       A valid CSR with subject CN=entity.test and SAN DNS:entity.test exists at ./entity.csr
When:  ca sign ./entity.csr --data-dir ./test-ca-data
Then:  The file ./test-ca-data/certs/02.pem is a valid PEM-encoded X.509v3 certificate
       The certificate version is 3
       Extension Basic Constraints is present, critical, with cA=FALSE
       Extension Key Usage is present, critical, with digitalSignature bit set
       Extension Subject Alternative Name is present, non-critical, containing DNS:entity.test
       Extension Authority Key Identifier is present, non-critical, matching the CA's Subject Key Identifier
       Extension Subject Key Identifier is present, non-critical
       The certificate issuer is "CN=Extension Test CA,O=Test,C=US" (the CA's subject)
       The certificate subject is "CN=entity.test"
```

```
SCN-DT-003: CRL has correct version and structure
Traces to: REQ-DT-004
Given: CA is initialized at ./test-ca-data
       One certificate (serial 02) has been revoked
When:  ca crl --data-dir ./test-ca-data
Then:  The file ./test-ca-data/ca.crl is a valid PEM-encoded X.509 CRL
       The CRL version is 2
       The CRL issuer matches the CA certificate subject
       The CRL has Authority Key Identifier extension matching the CA's SKI
       The CRL has a CRL Number extension with value 1
       The CRL contains exactly 1 revoked certificate entry
       The revoked entry serial number is 02 (hex)
       The CRL thisUpdate is a valid UTC timestamp
       The CRL nextUpdate is after thisUpdate
       The CRL signature is valid (verifiable with the CA's public key)
```

```
SCN-DT-004: Storage layout after full lifecycle
Traces to: REQ-DT-005, REQ-DT-006, REQ-DT-007
Given: An empty directory ./test-ca-data exists
When:  ca init --subject "CN=Layout Test CA" --data-dir ./test-ca-data
       Two CSRs are signed (serials 02 and 03)
       Certificate 02 is revoked
       CRL is generated
Then:  File ./test-ca-data/ca.key exists
       File ./test-ca-data/ca.crt exists
       File ./test-ca-data/serial exists and contains "04"
       File ./test-ca-data/crlnumber exists and contains "02"
       File ./test-ca-data/index.json exists and is valid JSON
       The JSON array in index.json has 2 entries
       Entry with serial "02" has status "revoked"
       Entry with serial "03" has status "active"
       File ./test-ca-data/certs/02.pem exists
       File ./test-ca-data/certs/03.pem exists
       File ./test-ca-data/ca.crl exists
```

```
SCN-DT-005: PEM encoding for all artifacts
Traces to: REQ-DT-001
Given: CA is initialized at ./test-ca-data
       A CSR has been generated with ca request (key at ./test.key, CSR at ./test.csr)
       The CSR has been signed (serial 02)
       A CRL has been generated
Then:  File ./test-ca-data/ca.key starts with "-----BEGIN PRIVATE KEY-----" and ends with "-----END PRIVATE KEY-----"
       File ./test-ca-data/ca.crt starts with "-----BEGIN CERTIFICATE-----" and ends with "-----END CERTIFICATE-----"
       File ./test.key starts with "-----BEGIN PRIVATE KEY-----" and ends with "-----END PRIVATE KEY-----"
       File ./test.csr starts with "-----BEGIN CERTIFICATE REQUEST-----" and ends with "-----END CERTIFICATE REQUEST-----"
       File ./test-ca-data/certs/02.pem starts with "-----BEGIN CERTIFICATE-----" and ends with "-----END CERTIFICATE-----"
       File ./test-ca-data/ca.crl starts with "-----BEGIN X509 CRL-----" and ends with "-----END X509 CRL-----"
```

### 5.4 Error Handling Scenarios (ER)

```
SCN-ER-001: Reject CSR with invalid self-signature
Traces to: REQ-ER-001, REQ-CP-002
Given: CA is initialized at ./test-ca-data
       A file ./invalid.csr exists containing a PEM-encoded CSR with a corrupted signature
When:  ca sign ./invalid.csr --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CSR signature verification failed"
       No new file is created in ./test-ca-data/certs/
       The serial file is unchanged
```

```
SCN-ER-002: Reject commands when CA not initialized
Traces to: REQ-ER-002
Given: An empty directory ./test-ca-data exists (no ca.key or ca.crt)
When:  ca sign ./some.csr --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CA not initialized. Run 'ca init' first."

When:  ca revoke 02 --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CA not initialized. Run 'ca init' first."

When:  ca list --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CA not initialized. Run 'ca init' first."

When:  ca crl --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CA not initialized. Run 'ca init' first."

When:  ca verify ./some.pem --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CA not initialized. Run 'ca init' first."
```

```
SCN-ER-003: Reject revocation of non-existent serial
Traces to: REQ-ER-003
Given: CA is initialized at ./test-ca-data
       No certificate with serial ff exists in index.json
When:  ca revoke ff --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: certificate with serial ff not found"
```

```
SCN-ER-004: Reject double revocation
Traces to: REQ-ER-004
Given: CA is initialized at ./test-ca-data
       Certificate with serial 02 has already been revoked
When:  ca revoke 02 --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: certificate with serial 02 is already revoked"
```

```
SCN-ER-005: Reject re-initialization of existing CA
Traces to: REQ-ER-005
Given: CA is already initialized at ./test-ca-data (ca.key and ca.crt exist)
When:  ca init --subject "CN=Another CA" --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: CA already initialized at ./test-ca-data"
       The existing ca.key and ca.crt are NOT overwritten
```

```
SCN-ER-006: Reject CSR with unsupported key algorithm
Traces to: REQ-ER-006
Given: CA is initialized at ./test-ca-data
       A file ./weak.csr exists containing a PEM-encoded CSR with an RSA 1024-bit key
When:  ca sign ./weak.csr --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: unsupported key algorithm in CSR. Supported: ECDSA P-256, RSA 2048"
       No new file is created in ./test-ca-data/certs/
```

```
SCN-ER-007: Verify rejects certificate not signed by this CA
Traces to: REQ-ER-007
Given: CA is initialized at ./test-ca-data
       A file ./foreign.pem contains a certificate signed by a different CA
When:  ca verify ./foreign.pem --data-dir ./test-ca-data
Then:  Exit code is 1
       Stdout contains "Certificate verification: INVALID"
       Stdout contains "Signature:  FAILED"
```

```
SCN-ER-008: Reject non-PEM input as CSR
Traces to: REQ-ER-008
Given: CA is initialized at ./test-ca-data
       A file ./garbage.csr contains "This is not a CSR"
When:  ca sign ./garbage.csr --data-dir ./test-ca-data
Then:  Exit code is 1
       Stderr contains "Error: failed to parse CSR from ./garbage.csr"
```

### 5.5 Mock Boundary Scenarios (MK)

```
SCN-MK-001: CA signs CSR without identity verification
Traces to: REQ-MK-001, REQ-MK-004
Given: CA is initialized at ./test-ca-data
       A valid CSR ./anyone.csr exists with subject "CN=i-am-anyone.com" and a valid self-signature
       No domain ownership or identity check is performed
When:  ca sign ./anyone.csr --data-dir ./test-ca-data
Then:  Exit code is 0
       A certificate is issued with subject "CN=i-am-anyone.com"
       Stdout contains "Certificate issued successfully."
```

```
SCN-MK-002: CA key stored unencrypted with warning
Traces to: REQ-MK-002
Given: An empty directory ./test-ca-data exists
When:  ca init --subject "CN=Unprotected CA" --data-dir ./test-ca-data
Then:  Exit code is 0
       File ./test-ca-data/ca.key is a valid PEM-encoded private key
       The PEM header is "-----BEGIN PRIVATE KEY-----" (not "-----BEGIN ENCRYPTED PRIVATE KEY-----")
       Stdout contains "Warning: CA private key is stored unencrypted at ./test-ca-data/ca.key. Protect this file."
```

```
SCN-MK-003: CRL written to local file only
Traces to: REQ-MK-003
Given: CA is initialized at ./test-ca-data
When:  ca crl --data-dir ./test-ca-data
Then:  Exit code is 0
       File ./test-ca-data/ca.crl exists
       No HTTP server is started
       Stdout contains "CRL: ./test-ca-data/ca.crl"
```

```
SCN-MK-004: Operations print to stdout as audit log
Traces to: REQ-MK-005
Given: CA is initialized at ./test-ca-data
When:  ca sign ./valid.csr --data-dir ./test-ca-data
Then:  Stdout contains "Certificate issued successfully."
       Stdout contains "Serial:" with the assigned serial number
       Stdout contains "Subject:" with the certificate subject

When:  ca revoke 02 --reason keyCompromise --data-dir ./test-ca-data
Then:  Stdout contains "Certificate revoked successfully."
       Stdout contains "Serial: 02"
       Stdout contains "Reason: keyCompromise"
```

---

## 6. Traceability Matrix

### 6.1 Requirement → Scenario Mapping

| Requirement | Scenarios |
|-------------|-----------|
| REQ-CP-001 | SCN-CP-001, SCN-CP-002 |
| REQ-CP-002 | SCN-CP-001, SCN-CP-003, SCN-ER-001 |
| REQ-CP-003 | SCN-CP-001, SCN-CL-003 |
| REQ-CP-004 | SCN-CP-004 |
| REQ-CP-005 | SCN-CP-001, SCN-CP-005, SCN-CL-004 |
| REQ-CP-006 | SCN-CP-001, SCN-CP-006 |
| REQ-CP-007 | SCN-CP-001, SCN-CP-007, SCN-CP-008 |
| REQ-CP-008 | SCN-CL-005 |
| REQ-CL-001 | SCN-CL-001, SCN-CL-002 |
| REQ-CL-002 | SCN-CL-003 |
| REQ-CL-003 | SCN-CL-004 |
| REQ-CL-004 | SCN-CP-006 |
| REQ-CL-005 | SCN-CL-005, SCN-CL-006 |
| REQ-CL-006 | SCN-CP-007, SCN-CP-008, SCN-ER-007 |
| REQ-CL-007 | SCN-CL-007, SCN-CL-013 |
| REQ-CL-008 | SCN-CL-008, SCN-CL-009 |
| REQ-CL-009 | SCN-CL-010, SCN-CL-011, SCN-CL-012, SCN-CL-013 |
| REQ-DT-001 | SCN-DT-001, SCN-DT-005 |
| REQ-DT-002 | SCN-CP-002, SCN-DT-001 |
| REQ-DT-003 | SCN-DT-002 |
| REQ-DT-004 | SCN-CP-006, SCN-DT-003 |
| REQ-DT-005 | SCN-DT-004 |
| REQ-DT-006 | SCN-DT-004 |
| REQ-DT-007 | SCN-DT-004 |
| REQ-ER-001 | SCN-CP-003, SCN-ER-001 |
| REQ-ER-002 | SCN-ER-002 |
| REQ-ER-003 | SCN-ER-003 |
| REQ-ER-004 | SCN-ER-004 |
| REQ-ER-005 | SCN-ER-005 |
| REQ-ER-006 | SCN-ER-006 |
| REQ-ER-007 | SCN-ER-007 |
| REQ-ER-008 | SCN-ER-008 |
| REQ-MK-001 | SCN-MK-001 |
| REQ-MK-002 | SCN-MK-002 |
| REQ-MK-003 | SCN-MK-003 |
| REQ-MK-004 | SCN-MK-001 |
| REQ-MK-005 | SCN-MK-004 |
| REQ-MK-006 | SCN-CP-002 (timestamps are system-clock-based throughout all scenarios) |

### 6.2 Scenario → Requirement Mapping

| Scenario | Requirements |
|----------|-------------|
| SCN-CP-001 | REQ-CP-001, REQ-CP-002, REQ-CP-003, REQ-CP-005, REQ-CP-006, REQ-CP-007 |
| SCN-CP-002 | REQ-CP-001, REQ-DT-002 |
| SCN-CP-003 | REQ-CP-002, REQ-ER-001 |
| SCN-CP-004 | REQ-CP-004 |
| SCN-CP-005 | REQ-CP-005 |
| SCN-CP-006 | REQ-CP-006, REQ-DT-004, REQ-CL-004 |
| SCN-CP-007 | REQ-CP-007, REQ-CL-006 |
| SCN-CP-008 | REQ-CP-007 |
| SCN-CL-001 | REQ-CL-001, REQ-CL-008 |
| SCN-CL-002 | REQ-CL-001 |
| SCN-CL-003 | REQ-CL-002, REQ-CP-003 |
| SCN-CL-004 | REQ-CL-003, REQ-CP-005 |
| SCN-CL-005 | REQ-CL-005, REQ-CP-008 |
| SCN-CL-006 | REQ-CL-005 |
| SCN-CL-007 | REQ-CL-007 |
| SCN-CL-008 | REQ-CL-008 |
| SCN-CL-009 | REQ-CL-008 |
| SCN-CL-010 | REQ-CL-009 |
| SCN-CL-011 | REQ-CL-009 |
| SCN-CL-012 | REQ-CL-009 |
| SCN-CL-013 | REQ-CL-007, REQ-CL-009 |
| SCN-DT-001 | REQ-DT-001, REQ-DT-002 |
| SCN-DT-002 | REQ-DT-001, REQ-DT-003 |
| SCN-DT-003 | REQ-DT-004 |
| SCN-DT-004 | REQ-DT-005, REQ-DT-006, REQ-DT-007 |
| SCN-DT-005 | REQ-DT-001 |
| SCN-ER-001 | REQ-ER-001, REQ-CP-002 |
| SCN-ER-002 | REQ-ER-002 |
| SCN-ER-003 | REQ-ER-003 |
| SCN-ER-004 | REQ-ER-004 |
| SCN-ER-005 | REQ-ER-005 |
| SCN-ER-006 | REQ-ER-006 |
| SCN-ER-007 | REQ-ER-007, REQ-CL-006 |
| SCN-ER-008 | REQ-ER-008 |
| SCN-MK-001 | REQ-MK-001, REQ-MK-004 |
| SCN-MK-002 | REQ-MK-002 |
| SCN-MK-003 | REQ-MK-003 |
| SCN-MK-004 | REQ-MK-005 |

### 6.3 Coverage Gaps

**None.** Every requirement maps to at least one scenario. Every scenario maps to at least one requirement. REQ-CL-009 is covered by SCN-CL-010 (missing required flag), SCN-CL-011 (invalid flag value), SCN-CL-012 (unknown command), and SCN-CL-013 (invalid SAN format).

---

## 7. Glossary

| Term | Definition |
|------|-----------|
| **CA** | Certificate Authority — the entity that issues, signs, and revokes certificates. |
| **X.509v3** | Version 3 of the ITU-T X.509 standard for public key certificates, profiled for the Internet by RFC 5280. |
| **CSR** | Certificate Signing Request — a PKCS#10 (RFC 2986) message containing a public key, identity, and self-signature. |
| **CRL** | Certificate Revocation List — a signed list of serial numbers of revoked certificates, published by the CA. |
| **PEM** | Privacy-Enhanced Mail encoding — Base64-encoded DER data wrapped in `-----BEGIN/END-----` headers. |
| **DN** | Distinguished Name — an X.500 name identifying a certificate subject or issuer (e.g., `CN=example.com,O=Org,C=US`). |
| **SAN** | Subject Alternative Name — an X.509v3 extension listing additional identities (DNS names, IPs) bound to a certificate. |
| **Serial Number** | A unique identifier assigned by the CA to each certificate, represented as a hexadecimal string. |
| **ECDSA P-256** | Elliptic Curve Digital Signature Algorithm using the NIST P-256 curve. |
| **RSA 2048** | RSA algorithm with a 2048-bit key. |
| **SHA-256** | Secure Hash Algorithm producing a 256-bit digest, used for all signatures in this system. |
| **PKCS#8** | Private-Key Information Syntax Standard — the encoding format used for private keys in PEM files. |
| **RFC 3339** | Date/time format standard used for all timestamps (e.g., `2026-02-09T12:00:00Z`). |
